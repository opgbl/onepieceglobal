const API_URL="https://opapi.onrender.com";const els=(s,p=document)=>Array.from(p.querySelectorAll(s));const $=(s,p=document)=>p.querySelector(s);let TOKEN=null;let TOKEN_EXP=null;function setToken(t,e=86400){TOKEN=t;TOKEN_EXP=Date.now()+1e3*e;localStorage.setItem("opg_jwt",t);localStorage.setItem("opg_jwt_exp",String(TOKEN_EXP));updateAuthUI()}function loadToken(){TOKEN=localStorage.getItem("opg_jwt");TOKEN_EXP=Number(localStorage.getItem("opg_jwt_exp")||0);if(!TOKEN||!TOKEN_EXP||Date.now()>TOKEN_EXP){clearToken();return}updateAuthUI()}function clearToken(){TOKEN=null;TOKEN_EXP=null;localStorage.removeItem("opg_jwt");localStorage.removeItem("opg_jwt_exp");updateAuthUI()}function authHeaders(e={}){const t={"Content-Type":"application/json"};return TOKEN&&(t.Authorization="Bearer "+TOKEN),{...t,...e}}function setMsg(e,t,o=!1){e.textContent=t||"",e.style.color=o?"#3fb950":t?"#f85149":""}function updateAuthUI(){const e=$("#tokenInfo"),t=$("#loginBox"),o=$("#tabs"),n=$("#btnLogout");if(TOKEN){const t=Math.max(0,Math.floor((TOKEN_EXP-Date.now())/1e3)),o=Math.floor(t/3600),s=Math.floor(t%3600/60);e.textContent=`Autenticado · expira en ${o}h ${s}m`,e.classList.add("ok"),n.classList.remove("hidden"),t.classList.add("hidden"),o.classList.remove("hidden")}else e.textContent="No autenticado",e.classList.remove("ok"),n.classList.add("hidden"),t.classList.remove("hidden"),o.classList.add("hidden")}async function login(){const e=$("#password").value,t=await fetch(API_URL+"/api/admin/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:e})}),o=await t.json().catch(()=>({}));if(!t.ok){setMsg($("#loginMsg"),o.error||"Error de login");return}setToken(o.token,o.expires_in||86400),setMsg($("#loginMsg"),"OK",!0),await recargarListas()}function bindTabs(){els(".tab").forEach(e=>{e.addEventListener("click",()=>{els(".tab").forEach(e=>e.classList.remove("active")),els(".tabpane").forEach(e=>e.classList.add("hidden")),e.classList.add("active"),$("#"+e.dataset.tab).classList.remove("hidden")})})}async function fetchJSON(e,t={}){const o=await fetch(e,t);if(o.headers.get("content-type")?.includes("application/json")){const e=await o.json();if(!o.ok)throw new Error(e.error||"Error");return e}else{if(!o.ok)throw new Error("Error HTTP "+o.status);return null}}async function getPublicEpisodes(){const e=await fetchJSON(API_URL+"/api/episodes");return e.items||[]}function toAdminPayload(e){const t=t=>$("#"+e+t).value.trim();return{episodio:t("-episodio"),titulo:t("-titulo"),fecha:t("-fecha"),embed:t("-embed"),dl1080:t("-dl1080"),dl720:t("-dl720"),dl480:t("-dl480")}}async function recargarListas(){const e=await getPublicEpisodes(),t=$("#list");t.innerHTML="";const o=$("#q").value.trim().toLowerCase();e.filter(e=>!o||(String(e.id||e.episodio).includes(o)||(e.title||e.titulo||"").toLowerCase().includes(o))).forEach(e=>{const o=document.createElement("div");o.className="row";const n=e.episodio??e.id,s=e.titulo??e.title;o.innerHTML=`<div class="cell">#${n}</div><div class="cell">${s||""}</div><div class="cell"><button class="btn tiny" data-copy="/onepieceglobal/video.html?id=${n}">Copiar link</button></div>`,t.appendChild(o)});const n=e=>{e.innerHTML="",e.appendChild(new Option("",""));e.forEach;e};const s=e=>{e.innerHTML="";e.appendChild(new Option("Selecciona",""));e};const i=$("#edit-select");const a=$("#del-select");i.innerHTML="";a.innerHTML="";e.forEach(e=>{const t=document.createElement("option");t.value=String(e.episodio??e.id),t.textContent=`${e.episodio??e.id} - ${(e.titulo??e.title)||""}`,i.appendChild(t);const o=t.cloneNode(!0);a.appendChild(o)})}async function publicar(){const e=toAdminPayload("pub");try{const t=await fetchJSON(API_URL+"/api/admin/episodes",{method:"POST",headers:authHeaders(),body:JSON.stringify(e)});setMsg($("#pubMsg"),"Publicado ID "+(t.id||t.episodio),!0),await recargarListas()}catch(e){setMsg($("#pubMsg"),e.message)}}async function cargarSeleccionParaEditar(){const e=$("#edit-select").value;if(!e){setMsg($("#editMsg"),"Selecciona un episodio");return}const t=await getPublicEpisodes(),o=t.find(t=>String(t.episodio??t.id)===String(e));if(!o){setMsg($("#editMsg"),"No encontrado");return}$("#edit-episodio").value=o.episodio??o.id??"",$("#edit-titulo").value=o.titulo??o.title??"",$("#edit-fecha").value=o.fecha??"",$("#edit-embed").value=o.embed??"",$("#edit-dl1080").value=o.dl1080??"",$("#edit-dl720").value=o.dl720??"",$("#edit-dl480").value=o.dl480??"",setMsg($("#editMsg"),"")}async function guardarEdicion(){const e=$("#edit-select").value;if(!e){setMsg($("#editMsg"),"Selecciona un episodio");return}const t=toAdminPayload("edit");try{await fetchJSON(API_URL+"/api/admin/episodes/"+encodeURIComponent(e),{method:"PUT",headers:authHeaders(),body:JSON.stringify(t)}),setMsg($("#editMsg"),"Guardado",!0),await recargarListas()}catch(e){setMsg($("#editMsg"),e.message)}}async function eliminar(){const e=$("#del-select").value;if(!e){setMsg($("#delMsg"),"Selecciona un episodio");return}if(!confirm("¿Eliminar episodio "+e+"?"))return;const t=$("#del-apikey").value.trim(),o=authHeaders();t&&(o["X-API-SECRET"]=t);try{await fetchJSON(API_URL+"/api/admin/episodes/"+encodeURIComponent(e),{method:"DELETE",headers:o}),setMsg($("#delMsg"),"Eliminado",!0),await recargarListas()}catch(e){setMsg($("#delMsg"),e.message)}}function bindListActions(){$("#btnRecargar").addEventListener("click",recargarListas),$("#q").addEventListener("input",recargarListas),$("#list").addEventListener("click",e=>{const t=e.target.closest("[data-copy]");if(!t)return;const o=t.getAttribute("data-copy"),n=location.origin+o;navigator.clipboard.writeText(n).then(()=>{t.textContent="Copiado",setTimeout(()=>t.textContent="Copiar link",1e3)})})}function bindImportar(){$("#btnEjemplo").addEventListener("click",()=>{$("#jsonInput").value=JSON.stringify([{episodio:3,titulo:"Ejemplo",fecha:"2025-08-16",embed:"",dl1080:"",dl720:"",dl480:""}],null,2)}),$("#btnImportar").addEventListener("click",async()=>{try{const e=JSON.parse($("#jsonInput").value);if(!Array.isArray(e)||!e.length)throw new Error("JSON inválido");for(const t of e)await fetchJSON(API_URL+"/api/admin/episodes",{method:"POST",headers:authHeaders(),body:JSON.stringify(t)});setMsg($("#impMsg"),"Importado",!0),$("#jsonInput").value="",await recargarListas()}catch(e){setMsg($("#impMsg"),e.message)}})}function bindUI(){bindTabs(),bindListActions(),bindImportar(),$("#btnLogin").addEventListener("click",login),$("#btnLogout").addEventListener("click",clearToken),$("#btnPublicar").addEventListener("click",publicar),$("#edit-select").addEventListener("change",cargarSeleccionParaEditar),$("#btnGuardar").addEventListener("click",guardarEdicion),$("#btnEliminar").addEventListener("click",eliminar)}function init(){loadToken(),bindUI(),recargarListas().catch(()=>{})}init();

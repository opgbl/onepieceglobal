let tsReady=false;async function ensureTurnstile(){if(tsReady)return;const t=await turnstile.execute("0x4AAAAAABshM4-GXFL3s8tGkAl7gsKBXIU",{action:"catalog"});const r=await fetch(API_URL+"/api/verify-turnstile",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})});if(!r.ok)throw new Error("Turnstile failed");tsReady=true}const grid=document.getElementById("grid");const q=document.getElementById("q");async function fetchEpisodes(){await ensureTurnstile();const r=await fetch(API_URL+"/api/episodes",{credentials:"include"});if(!r.ok)throw new Error("API error");const data=await r.json();return data.items||[]}function render(list){grid.innerHTML="";const tpl=document.getElementById("card-tpl");list.forEach(item=>{const node=tpl.content.cloneNode(true);node.querySelector(".title").textContent=`Episodio ${item.episodio??item.id}: ${item.titulo??item.title??""}`;const qwrap=node.querySelector(".qualities");["dl1080","dl720","dl480"].forEach(k=>{if(item[k]){const span=document.createElement("span");span.className="chip";span.textContent=k.replace("dl","")+"p";qwrap.appendChild(span)}});node.querySelector(".btn").href="./video.html?id="+(item.episodio??item.id);grid.appendChild(node)})}function filter(list,term){const t=term.trim().toLowerCase();if(!t)return list;return list.filter(e=>(e.titulo||e.title||"").toLowerCase().includes(t)||String(e.episodio||e.id).includes(t))}async function init(){try{const all=await fetchEpisodes();render(all);q.addEventListener("input",()=>render(filter(all,q.value)))}catch(e){grid.innerHTML='<p class="notice">No se pudo cargar el cat√°logo.</p>'}}window.addEventListener("DOMContentLoaded",init);

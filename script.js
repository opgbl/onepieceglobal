const SITE_KEY="0x4AAAAAABshM3tkI6jl4RQn";let tsReady=false,tsWidget=null;function mountTS(){if(tsWidget)return;tsWidget=turnstile.render("#ts",{sitekey:SITE_KEY,size:"invisible",callback:async t=>{const r=await fetch(API_URL+"/api/verify-turnstile",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})});tsReady=r.ok}})}async function ensureTurnstile(){if(tsReady)return;mountTS();turnstile.execute(tsWidget);const a=Date.now();while(!tsReady&&Date.now()-a<8000)await new Promise(r=>setTimeout(r,120));if(!tsReady)throw new Error("Turnstile failed")}const grid=document.getElementById("grid");const q=document.getElementById("q");async function fetchEpisodes(){await ensureTurnstile();const r=await fetch(API_URL+"/api/episodes",{credentials:"include"});if(!r.ok)throw new Error("API error");const d=await r.json();return d.items||[]}function render(l){grid.innerHTML="";const t=document.getElementById("card-tpl");l.forEach(i=>{const n=t.content.cloneNode(true);n.querySelector(".title").textContent=`Episodio ${i.episodio??i.id}: ${i.titulo??i.title??""}`;const q=n.querySelector(".qualities");["dl1080","dl720","dl480"].forEach(k=>{if(i[k]){const s=document.createElement("span");s.className="chip";s.textContent=k.replace("dl","")+"p";q.appendChild(s)}});n.querySelector(".btn").href="./video.html?id="+(i.episodio??i.id);grid.appendChild(n)})}function filter(l,t){const x=t.trim().toLowerCase();if(!x)return l;return l.filter(e=>(e.titulo||e.title||"").toLowerCase().includes(x)||String(e.episodio||e.id).includes(x))}async function init(){try{const all=await fetchEpisodes();render(all);q.addEventListener("input",()=>render(filter(all,q.value)))}catch(e){grid.innerHTML='<p class="notice">No se pudo cargar el cat√°logo.</p>'}}window.addEventListener("DOMContentLoaded",init);
